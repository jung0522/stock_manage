<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.goorm.board.mapper.SupplierMapper">

    <!-- SupplierDto ResultMap -->
    <resultMap id="supplierDtoResultMap" type="io.goorm.board.dto.supplier.SupplierDto">
        <id property="supplierSeq" column="supplier_seq"/>
        <result property="name" column="name"/>
        <result property="contactPerson" column="contact_person"/>
        <result property="email" column="email"/>
        <result property="phone" column="phone"/>
        <result property="address" column="address"/>
        <result property="description" column="description"/>
        <result property="isActive" column="is_active"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="createdSeq" column="created_seq"/>
        <result property="updatedSeq" column="updated_seq"/>
    </resultMap>

    <!-- 기본 컬럼 -->
    <sql id="supplierDtoColumns">
        s.supplier_seq, s.name, s.contact_person, s.email, s.phone,
        s.address, s.description, s.is_active,
        s.created_at, s.updated_at, s.created_seq, s.updated_seq
    </sql>

    <!-- 검색 조건 -->
    <sql id="searchConditions">
        <where>
            <if test="search.hasKeyword()">
                AND (s.name LIKE CONCAT('%', #{search.keyword}, '%')
                     OR s.contact_person LIKE CONCAT('%', #{search.keyword}, '%'))
            </if>
            <if test="search.email != null and search.email != ''">
                AND s.email LIKE CONCAT('%', #{search.email}, '%')
            </if>
            <if test="search.hasStatus()">
                <choose>
                    <when test="search.status.name() == 'ACTIVE'">
                        AND s.is_active = true
                    </when>
                    <when test="search.status.name() == 'INACTIVE'">
                        AND s.is_active = false
                    </when>
                </choose>
            </if>
        </where>
    </sql>

    <!-- 정렬 -->
    <sql id="orderBy">
        ORDER BY s.created_at DESC
    </sql>

    <!-- 활성 공급업체 목록 조회 -->
    <select id="findAllActive" resultMap="supplierDtoResultMap">
        SELECT <include refid="supplierDtoColumns"/>
        FROM suppliers s
        WHERE s.is_active = true
        ORDER BY s.name ASC
    </select>

    <!-- 활성 공급업체 + 선택된 공급업체 조회 -->
    <select id="findAllActiveOrSelected" resultMap="supplierDtoResultMap">
        SELECT <include refid="supplierDtoColumns"/>
        FROM suppliers s
        WHERE s.is_active = true
        <if test="selectedSupplierSeq != null">
            OR s.supplier_seq = #{selectedSupplierSeq}
        </if>
        ORDER BY s.name ASC
    </select>

    <!-- 공급업체 검색 (페이징) -->
    <select id="findAll" resultMap="supplierDtoResultMap">
        SELECT <include refid="supplierDtoColumns"/>
        FROM suppliers s
        <include refid="searchConditions"/>
        <include refid="orderBy"/>
        LIMIT #{search.offset}, #{search.size}
    </select>

    <!-- 공급업체 검색 개수 -->
    <select id="count" resultType="int">
        SELECT COUNT(*)
        FROM suppliers s
        <include refid="searchConditions"/>
    </select>

    <!-- 공급업체 상세 조회 -->
    <select id="findBySeq" resultMap="supplierDtoResultMap">
        SELECT <include refid="supplierDtoColumns"/>
        FROM suppliers s
        WHERE s.supplier_seq = #{supplierSeq}
    </select>

    <!-- 공급업체 등록 -->
    <insert id="insert" parameterType="io.goorm.board.dto.supplier.SupplierDto" useGeneratedKeys="true" keyProperty="supplier.supplierSeq">
        INSERT INTO suppliers (
            name, contact_person, email, phone, address, description,
            is_active, created_at, updated_at, created_seq, updated_seq
        ) VALUES (
            #{supplier.name}, #{supplier.contactPerson}, #{supplier.email},
            #{supplier.phone}, #{supplier.address}, #{supplier.description},
            #{supplier.isActive}, NOW(), NOW(),
            #{supplier.createdSeq}, #{supplier.updatedSeq}
        )
    </insert>

    <!-- 공급업체 수정 -->
    <update id="update">
        UPDATE suppliers SET
            name = #{supplier.name},
            contact_person = #{supplier.contactPerson},
            email = #{supplier.email},
            phone = #{supplier.phone},
            address = #{supplier.address},
            description = #{supplier.description},
            updated_at = NOW(),
            updated_seq = #{supplier.updatedSeq}
        WHERE supplier_seq = #{supplier.supplierSeq}
    </update>

    <!-- 공급업체 활성화 -->
    <update id="activate">
        UPDATE suppliers SET
            is_active = true,
            updated_at = NOW()
        WHERE supplier_seq = #{supplierSeq}
    </update>

    <!-- 공급업체 비활성화 -->
    <update id="deactivate">
        UPDATE suppliers SET
            is_active = false,
            updated_at = NOW()
        WHERE supplier_seq = #{supplierSeq}
    </update>

    <!-- 이메일 중복 체크 -->
    <select id="countByEmail" resultType="int">
        SELECT COUNT(*)
        FROM suppliers
        WHERE email = #{email}
    </select>

    <!-- 이메일 중복 체크 (자신 제외) -->
    <select id="countByEmailAndNotSeq" resultType="int">
        SELECT COUNT(*)
        FROM suppliers
        WHERE email = #{email}
        AND supplier_seq != #{supplierSeq}
    </select>

    <!-- Excel용 전체 공급업체 조회 -->
    <select id="findAllForExcel" resultMap="supplierDtoResultMap">
        SELECT <include refid="supplierDtoColumns"/>
        FROM suppliers s
        <include refid="searchConditions"/>
        <include refid="orderBy"/>
    </select>

</mapper>